# All right reserved.
#   (c) 2013 Paul Asmuth <paul@paulasmuth.com>

require 'test_helper'

class HeidelpayHcoNotificationTest < Test::Unit::TestCase
  include ActiveMerchant::Billing::Integrations

  def setup
    @notification = subject.new(test_response)
  end

  def subject
    ActiveMerchant::Billing::Integrations::HeidelpayHco::Notification
  end

  def test_success
    assert @notification.success?
    assert @notification.complete?
  end

  def test_payment_successful_status
    notification = subject.new("PROCESSING.STATUS.CODE=90")
    assert_equal "Completed", notification.status
    assert notification.success?
  end

  def test_payment_failure_status
    notification = subject.new("PROCESSING.STATUS.CODE=10")
    assert_equal "Failed", notification.status
    assert !notification.success?
  end

  def test_respond_to_acknowledge
    assert @notification.acknowledge
  end

  def test_transaction_id
    assert_equal "42", @notification.transaction_id
  end

  def test_amount
    assert_equal "23.00", @notification.amount
  end

  def test_received_at
    assert_equal "2013-06-09T21:35:47+00:00", @notification.received_at.to_s
  end

  private

  def test_response
    str = "NAME.SALUTATION=MR&TRANSACTION.CHANNEL=31HA07BC810C91F086433734258F6628&IDENTIFICATION.UNIQUEID=31HA07BC813FD614013A170F88239CE2&PROCESSING_REASON_CODE=00&PROCESSING_TIMESTAMP=2013-06-09+21%3A35%3A47&TRANSACTION.RESPONSE=SYNC&IDENTIFICATION_TRANSACTIONID=42&PROCESSING.STATUS.CODE=90&PROCESSING.RESULT=ACK&NAME_FAMILY=Mustermann&PRESENTATION.USAGE=Verwendungszweck&CONTACT_EMAIL=test%40test.de&TRANSACTION_RESPONSE=SYNC&ADDRESS_ZIP=12345&PROCESSING.RETURN=Request+successfully+processed+in+%27Merchant+in+Integrator+Test+Mode%27&PROCESSING.TIMESTAMP=2013-06-09+21%3A35%3A47&PROCESSING.REASON=SUCCESSFULL&PRESENTATION_AMOUNT=23.00&CLEARING.DATE=2013-06-09+21%3A35%3A47&IDENTIFICATION_SHORTID=2349.1294.7760&CLEARING.AMOUNT=23.00&PROCESSING_CODE=CC.DB.90.00&P3_VALIDATION=ACK&ADDRESS.STATE=DE1&POST_VALIDATION=ACK&ACCOUNT.BRAND=VISA&ADDRESS_COUNTRY=DE&CLEARING_CURRENCY=EUR&PROCESSING_RETURN_CODE=000.100.110&ACCOUNT_MONTH=10&TRANSACTION_MODE=INTEGRATOR_TEST&ADDRESS.COUNTRY=DE&NAME_SALUTATION=MR&PROCESSING_RESULT=ACK&PAYMENT_CODE=CC.DB&CLEARING.CURRENCY=EUR&ACCOUNT.NUMBER=401288******1881&IDENTIFICATION.SHORTID=2349.1294.7760&NAME_GIVEN=Hanz&CLEARING.DESCRIPTOR=2349.1294.7760+HPC+TEST-Merchant+%28No+3D%29+Verwendungszweck&PROCESSING_RETURN=Request+successfully+processed+in+%27Merchant+in+Integrator+Test+Mode%27&ACCOUNT.HOLDER=Hanz+Mustermann&PROCESSING_REASON=SUCCESSFULL&PROCESSING.STATUS=NEW&CLEARING_AMOUNT=23.00&PROCESSING.CODE=CC.DB.90.00&CONTACT.EMAIL=test%40test.de&PROCESSING_STATUS_CODE=90&PROCESSING.REASON.CODE=00&ADDRESS_CITY=Demo+City&TRANSACTION.MODE=INTEGRATOR_TEST&PAYMENT.CODE=CC.DB&ADDRESS.STREET=Musterstrasse+1&ACCOUNT_YEAR=2015&FRONTEND.REQUEST.CANCELLED=false&FRONTEND.RESPONSE_URL=https%3A%2F%2Ftest-heidelpay.hpcgw.net%2Fsgw%2Fpayment%2Fthreedsecure%3Bjsessionid%3D639090FAB1AF6E952E9336AF4E9D8D69.worker11&ACCOUNT_NUMBER=401288******1881&IDENTIFICATION.TRANSACTIONID=42&ACCOUNT.MONTH=10&ACCOUNT_HOLDER=Hanz+Mustermann&CLEARING_DESCRIPTOR=2349.1294.7760+HPC+TEST-Merchant+%28No+3D%29+Verwendungszweck&PRESENTATION_USAGE=Verwendungszweck&PROCESSING_STATUS=NEW&ADDRESS.CITY=Demo+City&NAME.GIVEN=Hanz&PRESENTATION_CURRENCY=EUR&PROCESSING.RETURN.CODE=000.100.110&ACCOUNT.YEAR=2015&FRONTEND_RESPONSE_URL=https%3A%2F%2Ftest-heidelpay.hpcgw.net%2Fsgw%2Fpayment%2Fthreedsecure%3Bjsessionid%3D639090FAB1AF6E952E9336AF4E9D8D69.worker11&ADDRESS.ZIP=12345&ACCOUNT_BRAND=VISA&ADDRESS_STREET=Musterstrasse+1&PRESENTATION.CURRENCY=EUR&NAME.FAMILY=Mustermann&CLEARING_SUPPORT=%2B49+%280%29+6543210123&P3.VALIDATION=ACK&RESPONSE_VERSION=1.0&PRESENTATION.AMOUNT=23.00&POST.VALIDATION=ACK&CLEARING.SUPPORT=%2B49+%280%29+6543210123&IDENTIFICATION_UNIQUEID=31HA07BC813FD614013A170F88239CE2&RESPONSE.VERSION=1.0&TRANSACTION_CHANNEL=31HA07BC810C91F086433734258F6628&CLEARING_DATE=2013-06-09+21%3A35%3A47&ADDRESS_STATE=DE1&FRONTEND_REQUEST_CANCELLED=false"
  end
end
